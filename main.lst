MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  1


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00001 ; $Id: main.asm,v 1.1 2007/01/25 16:12:52 tgipson Exp $
                      00002 ;
                      00003 ; 10F 1-Wire Receiver + Indicator
                      00004 
                      00005 ; Config bits: WDT ON, MCLR as GP3, CodeProtect OFF.
                      00006 
                      00007 ; c08
                      00008 
                      00009 ; WARNING: There is no 'BZ' (Branch if Zero) instruction on PIC10! The assembler fakes it using 'BTFSS S
                            TATUS,Z', which
                      00010 ; will NOT work as intended unless immediately followed by an unconditional branch.
                      00011 
                      00012 ; ----------------------
                      00013 
                      00014 #define         MYADDR          0x12            ; Personalized address to be stored in THIS chip. Each c
                            hip on the bus
                      00015                                                                         ; must have a unique address to 
                            be controlled independently...
                      00016 
                      00017 #define         COMM_ANODE      0x01            ; If indicator is common-anode, polarity of output drive
                             and idle are inverted
                      00018 
                      00019 ; ----------------------
                      00020 
                      00021 
                      00022 
                      00023         list    p=10f200
                      00024         #include "p10f200.inc"
                      00001         LIST
                      00002 ; P10F200.INC  Standard Header File, Version 1.02    Microchip Technology, Inc.
                      00125         LIST
                      00025 
                      00026 ;       org     0x01FE
                      00027 ;stop:
                      00028 ;       goto    stop
                      00029 ;
                      00030 ;       org     0x1FF
                      00031 ;       movlw   H'08'
                      00032 
                      00033 
0000                  00034         org 0x00                        ; effective reset vector
                      00035 ;       movwf   OSCCAL          ; set factory oscillator calibration value from last program memory byte
                             (set as MOVLW H'xx' from factory)
0000                  00036 start:
0000   0004           00037         clrwdt
0001   0CC8           00038         movlw   B'11001000'     ; wakeup-on-change DISabled, pullups DISabled, timer0 clk internal, sour
                            ce edge low-to-high (don't care), prescaler assigned to WDT, /1
                      00039 ;       movlw   B'11001111'     ; wakeup-on-change DISabled, pullups DISabled, timer0 clk internal, sour
                            ce edge low-to-high (don't care), prescaler assigned to WDT, /128
0002   0002           00040         OPTION
                      00041 
0003   0C00           00042         movlw   B'00000000'
0004   0006           00043         TRIS    GPIO
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  2


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0005   0066           00044         clrf    GPIO
                      00045 
0006   0526           00046         bsf             GPIO, GREEN             ; Check for reset...
0007   0546           00047         bsf             GPIO, BLUE
0008   0406           00048         bcf             GPIO, RED
                      00049 
0009   0072           00050         clrf    PWM_R
000A   0073           00051         clrf    PWM_G
000B   0074           00052         clrf    PWM_B
                      00053 
000C   0075           00054         clrf    GROUPADDR
                      00055 
000D   0CFE           00056         movlw   B'11111110'             ; debug - see if light lights / program running
000E   0032           00057         movwf   PWM_R                   ;
000F   0CFE           00058         movlw   B'11111110'
0010   0033           00059         movwf   PWM_G                   ;
0011   0CFE           00060         movlw   B'11111110'
0012   0034           00061         movwf   PWM_B                   ;
                      00062 
                      00063 
0013                  00064 reset_sync:                                     ; Sync with extended STOP condition
0013   0666           00065         btfsc   GPIO, SDI               ; SDI low?
0014   0A13           00066         goto    reset_sync              ; if no
                      00067 
0015   0004           00068         clrwdt
0016   0061           00069         clrf    TMR0                    ; begin timing stop condition
0017                  00070 reset_sync_wait1:
0017   0666           00071         btfsc   GPIO, SDI               ; line still low?
0018   0A13           00072         goto    reset_sync              ; if no
0019   06E1           00073         btfsc   TMR0, 7                 ; timer rollxxxer?
001A   0A17           00074         goto    reset_sync_wait1; if no
                      00075 
001B   0061           00076         clrf    TMR0                    ; reset timer
001C                  00077 reset_sync_wait2:
001C   0666           00078         btfsc   GPIO, SDI               ; line still low?
001D   0A13           00079         goto    reset_sync              ; if no
001E   06E1           00080         btfsc   TMR0, 7                 ; timer rollxxxer?
001F   0A1C           00081         goto    reset_sync_wait2; if no
                      00082                                                         ; else - fall through and begin running...
                      00083 
0020                  00084 main:
0020   0004           00085         clrwdt
0021   0932           00086         call    pwm                             ; 25 clocks, including call. 11 inc. call if separated..
                            .
0022   0766           00087         btfss   GPIO, SDI               ; start bit?
0023   0A20           00088         goto    main
0024   0A48           00089         goto    getcmd                  ; fake 'call' - shallow stack
                      00090 ;       movwf   SCRATCH0                ; move return status somewhere usable
                      00091 ;       incfsz  SCRATCH0,f              ; test it. Returned FF?
                      00092 ;       goto    main                    ; if no - no cmd
                      00093 
                      00094 ;       ; else, process cmd...
                      00095 
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  3


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00096         ; --- debug ---
                      00097 ;       movlw   CMDBUF                  ; point to 1st byte of CMDBUF (addr)
                      00098 ;       movwf   FSR                             ; ...
                      00099 ;       movf    INDF, w ; debug
                      00100 ;       movwf   PWM_R   ; - what address are we getting???
                      00101 ;       incf    FSR,f   ;
                      00102 ;       movf    INDF, w ;
                      00103 ;       movwf   PWM_G   ;
                      00104         ; --- end debug ---
                      00105 
                      00106 
                      00107 ; ---------------------------------------------------
                      00108 ; Given low 4 bits of cmd in INDF, shift that many '1's into SCRATCH0
                      00109 
0025                  00110 setpwm:
0025   0070           00111         clrf    SCRATCH0                ; clear temporary reg
0026   0200           00112         movf    INDF, w                 ; cmd value
0027   0E0F           00113         andlw   B'00001111'             ; mask off bogus bits
0028   0031           00114         movwf   COUNT                   ;
0029   0D00           00115         iorlw   B'00000000'             ; dummy op to affect 'Z'ero status. Intensity = 0?
002A   0643           00116         btfsc   STATUS, Z
002B   0A30           00117         goto    setpwm_done
                      00118 ;       bz              setpwm_done             ; if yes - leave register clear
                      00119 ;                                                       ; else...
                      00120 
002C                  00121 setpwm1:
002C   0503           00122         bsf             STATUS, C
002D   0370           00123         rlf             SCRATCH0,f
002E   02F1           00124         decfsz  COUNT,f                 ; done shifting in 1s?
002F   0A2C           00125         goto    setpwm1                 ; if no
0030                  00126 setpwm_done:
                      00127 
                      00128         if COMM_ANODE==1
0030   0270           00129         comf    SCRATCH0, f             ; HACK: common-anode LED
                      00130         endif
                      00131 
0031   0800           00132         retlw   0
                      00133 
                      00134 
                      00135 ; ---------------------------------------------------
                      00136 ; Perform one iteration/rotation of "poor man's PWM" for each color's register
                      00137 
                      00138 
0032                  00139 pwm:
                      00140                                                 ; ---------------
                      00141         if COMM_ANODE==0        ; Switched in for common-cathode drive
                      00142         rlf             PWM_R,f         ; FIXME: Separate r/g/b PWM loops, see below
                      00143         bcf             PWM_R, 0
                      00144         btfsc   STATUS, C
                      00145         bsf             PWM_R, 0
                      00146 
                      00147         bcf             GPIO, RED
                      00148         btfsc   STATUS, C
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  4


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00149         bsf             GPIO, RED
                      00150 
                      00151         rlf             PWM_G,f
                      00152         bcf             PWM_G, 0
                      00153         btfsc   STATUS, C
                      00154         bsf             PWM_G, 0
                      00155 
                      00156         bcf             GPIO, GREEN
                      00157         btfsc   STATUS, C
                      00158         bsf             GPIO, GREEN
                      00159 
                      00160         rlf             PWM_B,f
                      00161         bcf             PWM_B, 0
                      00162         btfsc   STATUS, C
                      00163         bsf             PWM_B, 0
                      00164 
                      00165         bcf             GPIO, BLUE
                      00166         btfsc   STATUS, C
                      00167         bsf             GPIO, BLUE
                      00168         endif
                      00169                                                         ; ---------------------
                      00170         if COMM_ANODE == 1              ; Switched in for common-anode drive
0032                  00171 pwm_r:
0032   0372           00172         rlf             PWM_R,f
0033   0412           00173         bcf             PWM_R, 0
0034   0603           00174         btfsc   STATUS, C
0035   0512           00175         bsf             PWM_R, 0
                      00176 
0036   0506           00177         bsf             GPIO, RED
0037   0703           00178         btfss   STATUS, C
0038   0406           00179         bcf             GPIO, RED
                      00180 ;       retlw   0
0039                  00181 pwm_g:
0039   0373           00182         rlf             PWM_G,f
003A   0413           00183         bcf             PWM_G, 0
003B   0603           00184         btfsc   STATUS, C
003C   0513           00185         bsf             PWM_G, 0
                      00186 
003D   0526           00187         bsf             GPIO, GREEN
003E   0703           00188         btfss   STATUS, C
003F   0426           00189         bcf             GPIO, GREEN
                      00190 ;       retlw   0
0040                  00191 pwm_b:
0040   0374           00192         rlf             PWM_B,f
0041   0414           00193         bcf             PWM_B, 0
0042   0603           00194         btfsc   STATUS, C
0043   0514           00195         bsf             PWM_B, 0
                      00196 
0044   0546           00197         bsf             GPIO, BLUE
0045   0703           00198         btfss   STATUS, C
0046   0446           00199         bcf             GPIO, BLUE
                      00200         endif
                      00201 
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  5


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

0047   0800           00202         retlw   0
                      00203 
                      00204 ; ---------------------------------------------------
                      00205 ; Check for incoming cmd byte on SDI. If cmd (start condition), receive the cmd packet to CMDBUF.
                      00206 ; ASSUMPTION: Start condition is long enough that the longest possible complete loop will still get us b
                            ack here in time to catch it.
                      00207 
0048                  00208 getcmd:
0048   0C16           00209         movlw   CMDBUF                  ; init buffer ptr
0049   0024           00210         movwf   FSR                             ;
                      00211 
004A                  00212 getstartbit:
004A   0666           00213         btfsc   GPIO, SDI               ; spinlock until start condition released
004B   0A4A           00214         goto    getstartbit             ; ...
                      00215 
                      00216 ;       clrwdt
                      00217 
004C   0983           00218         call    getbyte                 ; addr
004D   0260           00219         comf    INDF,f  ;hack: bits inverted?
004E   02A4           00220         incf    FSR,f
004F   0983           00221         call    getbyte                 ; cmd
0050   0260           00222         comf    INDF,f  ;hack: bits inverted?
                      00223 
                      00224 
                      00225         ; check address
0051   0C16           00226         movlw   CMDBUF                  ; point to 1st byte of CMDBUF (addr)
0052   0024           00227         movwf   FSR                             ; ...
                      00228 
0053   0C00           00229         movlw   H'00'                   ; General Call addr? (everybody! everybody!)
0054   0180           00230         xorwf   INDF, w                 ;
0055   0643           00231         btfsc   STATUS, Z
0056   0A60           00232         goto    processcmd
                      00233 ;       bz              processcmd
                      00234 
                      00235 
0057   0C12           00236         movlw   MYADDR                  ; This chip's addr?
0058   0180           00237         xorwf   INDF, W                 ;
0059   0643           00238         btfsc   STATUS, Z
005A   0A60           00239         goto    processcmd
                      00240 ;       bz              processcmd
                      00241 
005B   0215           00242         movf    GROUPADDR, w    ; This chip's Group addr?
005C   0180           00243         xorwf   INDF, W                 ;
005D   0643           00244         btfsc   STATUS, Z
005E   0A60           00245         goto    processcmd
                      00246 ;       bz              processcmd
                      00247 
                      00248 
005F   0A20           00249         goto    main                    ; else - not for us...
                      00250 
0060                  00251 processcmd:
                      00252 
                      00253 ;       movlw   H'FF'           ; debug
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  6


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00254 ;       movwf   PWM_B           ; - check for getting here
                      00255 
0060   0C17           00256         movlw   CMDBUF+1                ; point to 2nd byte of CMDBUF (cmd)
0061   0024           00257         movwf   FSR                             ; ...
                      00258 
0062   0680           00259         btfsc   INDF, 4                 ; Extended Command bit
0063   0A6B           00260         goto    extcmd
                      00261 
0064   06E0           00262         btfsc   INDF, 7                 ; R cmd
0065   0977           00263         call    processcmd_r
0066   06C0           00264         btfsc   INDF, 6                 ; G cmd
0067   097B           00265         call    processcmd_g
0068   06A0           00266         btfsc   INDF, 5                 ; B cmd
0069   097F           00267         call    processcmd_b
006A   0A20           00268         goto    main                    ; done
                      00269 
                      00270 
006B                  00271 extcmd:                                         ; Extended commands are handled here
                      00272 ;       movlw   b'11111110'             ; debug
                      00273 ;       movwf   PWM_R                   ; debug
                      00274 
006B   0200           00275         movf    INDF, w                 ; Decode cmd to SCRATCH0
006C   0EE0           00276         andlw   B'11100000'             ; ...
006D   0030           00277         movwf   SCRATCH0                ;
                      00278 
006E   0C00           00279         movlw   H'00'
006F   0190           00280         xorwf   SCRATCH0, w
0070   0643           00281         btfsc   STATUS, Z
0071   0A73           00282         goto    setgroup
                      00283 ;       movlw   b'11111110'             ; debug
                      00284 ;       movwf   PWM_G                   ; debug
                      00285         ; ... other extended commands here ...
                      00286 
0072   0A20           00287         goto    main
                      00288 
                      00289 
                      00290 
0073                  00291 setgroup:
0073   0200           00292         movf    INDF, w
0074   0E0F           00293         andlw   B'00001111'
0075   0035           00294         movwf   GROUPADDR               ; store low nibble of extended cmd as group address
                      00295 ;       movlw   b'11111110'             ; debug
                      00296 ;       movwf   PWM_B                   ; debug
0076   0A20           00297         goto    main
                      00298 
                      00299 ; ---------------------------------------------------
                      00300 ; Process command byte in buffer for the given color
                      00301 
0077                  00302 processcmd_r:
0077   0925           00303         call    setpwm
0078   0210           00304         movf    SCRATCH0, w
0079   0032           00305         movwf   PWM_R
007A   0800           00306         retlw   0
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  7


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00307 
007B                  00308 processcmd_g:
007B   0925           00309         call    setpwm
007C   0210           00310         movf    SCRATCH0, w
007D   0033           00311         movwf   PWM_G
007E   0800           00312         retlw   0
                      00313 
007F                  00314 processcmd_b:
007F   0925           00315         call    setpwm
0080   0210           00316         movf    SCRATCH0, w
0081   0034           00317         movwf   PWM_B
0082   0800           00318         retlw   0
                      00319 
                      00320 
                      00321 ; -------------------------------
                      00322 
                      00323 
0083                  00324 getbyte:
0083   0C08           00325         movlw   H'08'                   ; rotate this many times
0084   0031           00326         movwf   COUNT                   ;
                      00327 
                      00328 
0085                  00329 getbit_waiting:
0085   0932           00330         call    pwm                             ; ONCE, in dead time. 25 clocks, including call; +10 aft
                            er bit received
0086                  00331 getbit_donewaiting:
0086   0766           00332         btfss   GPIO, SDI                       ; wait for SDI to go high - has it?
0087   0A86           00333         goto    getbit_donewaiting      ; if no
                      00334 
0088   0061           00335         clrf    TMR0                    ; if yes
                      00336 
0089                  00337 getbit_ready:
0089   0666           00338         btfsc   GPIO, SDI               ; now waiting for bit to go low again - has it?
008A   0A89           00339         goto    getbit_ready    ; if no
                      00340 
008B   0201           00341         movf    TMR0, w                 ; get timer's value
008C   0030           00342         movwf   SCRATCH0                ; .. to scratch reg (ghetto chip doesn't allow operation on WREG
                            ..?)
008D   0370           00343         rlf             SCRATCH0,f              ; rotate MSB of TMR0 into 'C'arry (don't care about othe
                            r bits)
008E   0370           00344         rlf             SCRATCH0,f              ; .. however many times for desired timer resolution
008F   0370           00345         rlf             SCRATCH0,f              ; hbit=40h qbit=20h
                      00346 ;       rlf             SCRATCH0,f              ; hbit=20h qbit=10h
0090   0360           00347         rlf             INDF,f                  ; shift bit in 'C'arry into currently-addressed buffer p
                            osition
0091   02F1           00348         decfsz  COUNT,f                 ; got all bits?
0092   0A85           00349         goto    getbit_waiting  ; if no - wait for next
0093   0800           00350         retlw   0                               ; else - done
                      00351 
                      00352 
                      00353 
                      00354 
                      00355 ; -------------------
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  8


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

                      00356 
                      00357 
                      00358 ; Command packet format: <start> <addr[7..0]><cmd[7..0]>
                      00359 ; Start bit is HIGH and lasts for longer than the longest possible loop run, so that all devices are gua
                            ranteed to catch it.
                      00360 ; Subsequent bits are HIGH for either <128 timer clocks (logic 0) or >128 clocks (logic 1) ... can shift
                             timer0 MSB as detected bit
                      00361 ; ... assuming clocks aren't *insanely* skewed from one device to the next.
                      00362 
                      00363 
                      00364 ; Cmd BYTE format: RGBCIIII
                      00365 ; RGB: Which color(s) cmd applies to
                      00366 ; IIII: Set intensity (0 ~ 8)
                      00367 ; C: Indicates Extended Command as described below...
                      00368 
                      00369 ; --- Extended Commands ---
                      00370 ; 0001xxxx : Set Group Addr to value in xxxx
                      00371 
                      00372 #include "vars.inc"
                      00001 ; Vars
                      00002 
                      00003 
                      00004         cblock  0x10
                      00005 
  00000010            00006         SCRATCH0        ; general purpose scratch register
  00000011            00007         COUNT           ; bits-in-byte countdown
                      00008 
  00000012            00009         PWM_R           ; poor-man's PWM registers: '1' bits will be rotated around in them
  00000013            00010         PWM_G           ;
  00000014            00011         PWM_B           ;
                      00012 
  00000015            00013         GROUPADDR       ; Storage byte for Group Address
                      00014 
  00000016            00015         CMDBUF          ; buffer start - must be at end of vars
  00000017            00016         CMDBUF2         ; 2nd byte of cmd
                      00017         endc
                      00373 #include "defs.inc"
                      00001 
                      00002 
  00000003            00003 SDI             equ     3               ; FIXME: All bit defs
                      00004 
  00000000            00005 RED             equ     0
  00000001            00006 GREEN   equ     1
  00000002            00007 BLUE    equ     2
                      00374 
                      00375 ; NOTES: This eats almost 1/4 of the code space; remove or shorten if things get tight.
                      00376 ; 'DT' stores in a (1 byte -> 1 word) readable format; probably decodes as RETLW xx
0094                  00377 str_version:
0094   0824 0849 0864 00378         DT      "$Id: main.asm,v 1.1 2007/01/25 16:12:52 tgipson Exp $"
       083A 0820 086D 
       0861 0869 086E 
       082E 0861 0873 
       086D 082C 0876 
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE  9


LOC  OBJECT CODE     LINE SOURCE TEXT
  VALUE

       0820 0831 082E 
       0831 0820 0832 
       0830 0830 0837 
       082F 0830 0831 
       082F 0832 0835 
       0820 0831 0836 
       083A 0831 0832 
       083A 0835 0832 
       0820 0874 0867 
       0869 0870 0873 
       086F 086E 0820 
       0845 087
                      00379 
                      00380         end
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE 10


SYMBOL TABLE
  LABEL                             VALUE 

BLUE                              00000002
C                                 00000000
CAL0                              00000001
CAL1                              00000002
CAL2                              00000003
CAL3                              00000004
CAL4                              00000005
CAL5                              00000006
CAL6                              00000007
CMDBUF                            00000016
CMDBUF2                           00000017
COMM_ANODE                        0x01
COUNT                             00000011
DC                                00000001
F                                 00000001
FOSC4                             00000000
FSR                               00000004
GP0                               00000000
GP1                               00000001
GP2                               00000002
GP3                               00000003
GPIO                              00000006
GPWUF                             00000007
GREEN                             00000001
GROUPADDR                         00000015
INDF                              00000000
MYADDR                            0x12
NOT_GPPU                          00000006
NOT_GPWU                          00000007
NOT_PD                            00000003
NOT_TO                            00000004
OSCCAL                            00000005
PCL                               00000002
PS0                               00000000
PS1                               00000001
PS2                               00000002
PSA                               00000003
PWM_B                             00000014
PWM_G                             00000013
PWM_R                             00000012
RED                               00000000
SCRATCH0                          00000010
SDI                               00000003
STATUS                            00000003
T0CS                              00000005
T0SE                              00000004
TMR0                              00000001
W                                 00000000
Z                                 00000002
_CP_OFF                           00000FFF
_CP_ON                            00000FF7
_IntRC_OSC                        00000FFF
_MCLRE_OFF                        00000FEF
MPASM  5.06                          MAIN.ASM   1-25-2007  11:19:41         PAGE 11


SYMBOL TABLE
  LABEL                             VALUE 

_MCLRE_ON                         00000FFF
_WDT_OFF                          00000FFB
_WDT_ON                           00000FFF
__10F200                          00000001
extcmd                            0000006B
getbit_donewaiting                00000086
getbit_ready                      00000089
getbit_waiting                    00000085
getbyte                           00000083
getcmd                            00000048
getstartbit                       0000004A
main                              00000020
processcmd                        00000060
processcmd_b                      0000007F
processcmd_g                      0000007B
processcmd_r                      00000077
pwm                               00000032
pwm_b                             00000040
pwm_g                             00000039
pwm_r                             00000032
reset_sync                        00000013
reset_sync_wait1                  00000017
reset_sync_wait2                  0000001C
setgroup                          00000073
setpwm                            00000025
setpwm1                           0000002C
setpwm_done                       00000030
start                             00000000
str_version                       00000094


MEMORY USAGE MAP ('X' = Used,  '-' = Unused)

0000 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0040 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
0080 : XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX XXXXXXXXXXXXXXXX
00C0 : XXXXXXXXX------- ---------------- ---------------- ----------------

All other memory blocks unused.

Program Memory Words Used:   201
Program Memory Words Free:    55


Errors   :     0
Warnings :     0 reported,     0 suppressed
Messages :     0 reported,     0 suppressed

